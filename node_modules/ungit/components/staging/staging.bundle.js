(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var ko = require('knockout');
var inherits = require('util').inherits;
var components = require('ungit-components');
var programEvents = require('ungit-program-events');
var _ = require('lodash');
var filesToDisplayIncrmentBy = 50;
var filesToDisplayLimit = filesToDisplayIncrmentBy;
var fileType = require('../../source/utils/file-type.js');
// when discard button is clicked and disable discard warning is selected, for next 5 minutes disable discard warnings
var muteGraceTimeDuration = 60 * 1000 * 5;

components.register('staging', function(args) {
  return new StagingViewModel(args.server, args.repoPath);
});

var StagingViewModel = function(server, repoPath) {
  var self = this;
  this.server = server;
  this.repoPath = repoPath;
  this.filesByPath = {};
  this.files = ko.observableArray();
  this.commitMessageTitleCount = ko.observable(0);
  this.commitMessageTitle = ko.observable();
  this.commitMessageTitle.subscribe(function(value) {
    self.commitMessageTitleCount(value.length);
  });
  this.commitMessageBody = ko.observable();
  this.inRebase = ko.observable(false);
  this.inMerge = ko.observable(false);
  this.allStageFlag = ko.observable(false);
  this.HEAD = ko.observable();
  this.commitButtonVisible = ko.computed(function() {
    return !self.inRebase() && !self.inMerge();
  });
  this.nFiles = ko.computed(function() {
    return self.files().length;
  });
  this.nStagedFiles = ko.computed(function() {
    return self.files().filter(function(f) { return f.editState() === 'staged'; }).length;
  });
  this.stats = ko.computed(function() {
    return self.nFiles() + ' files, ' + self.nStagedFiles() + ' to be commited';
  });
  this.amend = ko.observable(false);
  this.canAmend = ko.computed(function() {
    return self.HEAD() && !self.inRebase() && !self.inMerge();
  });
  this.canStashAll = ko.computed(function() {
    return !self.amend();
  });
  this.showNux = ko.computed(function() {
    return self.files().length == 0 && !self.amend() && !self.inRebase();
  });
  this.committingProgressBar = components.create('progressBar', { predictionMemoryKey: 'committing-' + this.repoPath, temporary: true });
  this.rebaseContinueProgressBar = components.create('progressBar', { predictionMemoryKey: 'rebase-continue-' + this.repoPath, temporary: true });
  this.rebaseAbortProgressBar = components.create('progressBar', { predictionMemoryKey: 'rebase-abort-' + this.repoPath, temporary: true });
  this.mergeContinueProgressBar = components.create('progressBar', { predictionMemoryKey: 'merge-continue-' + this.repoPath, temporary: true });
  this.mergeAbortProgressBar = components.create('progressBar', { predictionMemoryKey: 'merge-abort-' + this.repoPath, temporary: true });
  this.stashProgressBar = components.create('progressBar', { predictionMemoryKey: 'stash-' + this.repoPath, temporary: true });
  this.commitValidationError = ko.computed(function() {
    if (!self.amend() && !self.files().some(function(file) { return file.editState() === 'staged' || file.editState() === 'patched'; }))
      return "No files to commit";

    if (self.files().some(function(file) { return file.conflict(); }))
      return "Files in conflict";

    if (!self.commitMessageTitle() && !self.inRebase()) return "Provide a title";

    if (self.textDiffType() === 'sidebysidediff') {
      var patchFiles = self.files().filter(function(file) { return file.editState() === 'patched'; });
      if (patchFiles.length > 0) return "Cannot patch with side by side view."
    }

    return "";
  });
  this.toggleSelectAllGlyphClass = ko.computed(function() {
    if (self.allStageFlag()) return 'glyphicon-unchecked';
    else return 'glyphicon-check';
  });

  this.refreshContentThrottled = _.throttle(this.refreshContent.bind(this), 400, { trailing: true });
  this.invalidateFilesDiffsThrottled = _.throttle(this.invalidateFilesDiffs.bind(this), 400, { trailing: true });
  this.refreshContentThrottled();
  this.textDiffType = ko.observable('textdiff');
  if (window.location.search.indexOf('noheader=true') >= 0)
    this.refreshButton = components.create('refreshbutton');
  this.loadAnyway = false;
  this.isDiagOpen = false;
  this.mutedTime = null;
}
StagingViewModel.prototype.updateNode = function(parentElement) {
  ko.renderTemplate('staging', this, {}, parentElement);
}
StagingViewModel.prototype.onProgramEvent = function(event) {
  if (event.event == 'request-app-content-refresh') {
    this.refreshContent();
    this.invalidateFilesDiffs();
  }
  if (event.event == 'working-tree-changed') {
    this.refreshContentThrottled();
    this.invalidateFilesDiffsThrottled();
  }
}
StagingViewModel.prototype.refreshContent = function(callback) {
  var self = this;
  this.server.get('/head', { path: this.repoPath, limit: 1 }, function(err, log) {
    if (err) {
      return err.errorCode == 'must-be-in-working-tree' ||
        err.errorCode == 'no-such-path';
    }
    if (log.length > 0) {
      var array = log[0].message.split('\n');
      self.HEAD({title: array[0], body: array.slice(2).join('\n')});
    }
    else self.HEAD(null);
  });
  this.server.get('/status', { path: this.repoPath, fileLimit: filesToDisplayLimit }, function(err, status) {
    if (err) {
      if (callback) callback(err);
      return err.errorCode == 'must-be-in-working-tree' ||
        err.errorCode == 'no-such-path';
    }

    if (Object.keys(status.files).length > filesToDisplayLimit && !self.loadAnyway) {
      if (self.isDiagOpen) {
        if (callback) callback();
        return;
      }
      self.isDiagOpen = true;
      var diag = components.create('TooManyFilesDialogViewModel', { title: 'Too many unstaged files', details: 'It is recommended to use command line as ungit may be too slow.'});

      diag.closed.add(function() {
        self.isDiagOpen = false;
        if (diag.result()) {
          self.loadAnyway = true;
          self.loadStatus(status, callback);
        } else {
          window.location.href = '/#/';
        }
      })

      programEvents.dispatch({ event: 'request-show-dialog', dialog: diag });
    } else {
      self.loadStatus(status, callback);
    }
  });
}
StagingViewModel.prototype.loadStatus = function(status, callback) {
  this.setFiles(status.files);
  this.inRebase(!!status.inRebase);
  this.inMerge(!!status.inMerge);
  if (status.inMerge) {
    var lines = status.commitMessage.split('\n');
    this.commitMessageTitle(lines[0]);
    this.commitMessageBody(lines.slice(1).join('\n'));
  }
  if (callback) callback();
}
StagingViewModel.prototype.setFiles = function(files) {
  var self = this;
  var newFiles = [];
  for(var file in files) {
    var fileViewModel = this.filesByPath[file];
    if (!fileViewModel) {
      this.filesByPath[file] = fileViewModel = new FileViewModel(self, file, self.textDiffType);
    } else {
      // this is mainly for patching and it may not fire due to the fact that
      // '/commit' triggers working-tree-changed which triggers throttled refresh
      fileViewModel.invalidateDiff();
    }
    fileViewModel.setState(files[file]);
    newFiles.push(fileViewModel);
  }
  this.files(newFiles);
  programEvents.dispatch({ event: 'init-tooltip' });
}
StagingViewModel.prototype.toggleAmend = function() {
  if (!this.amend() && !this.commitMessageTitle()) {
    this.commitMessageTitle(this.HEAD().title);
    this.commitMessageBody(this.HEAD().body);
  }
  else if(this.amend()) {
    var isPrevDefaultMsg =
      this.commitMessageTitle() == this.HEAD().title &&
      this.commitMessageBody() == this.HEAD().body;
    if (isPrevDefaultMsg) {
      this.commitMessageTitle('');
      this.commitMessageBody('');
    }
  }
  this.amend(!this.amend());
}
StagingViewModel.prototype.resetMessages = function() {
  this.commitMessageTitle('');
  this.commitMessageBody('');
  this.amend(false);
}
StagingViewModel.prototype.commit = function() {
  var self = this;
  this.committingProgressBar.start();
  var files = this.files().filter(function(file) {
    return file.editState() !== 'none';
  }).map(function(file) {
    return { name: file.name(), patchLineList: file.editState() === 'patched' ? file.patchLineList() : null };
  });
  var commitMessage = this.commitMessageTitle();
  if (this.commitMessageBody()) commitMessage += '\n\n' + this.commitMessageBody();
  this.server.post('/commit', { path: this.repoPath, message: commitMessage, files: files, amend: this.amend() }, function(err, res) {
    self.committingProgressBar.stop();
    if (err) {
      return;
    }
    self.resetMessages();
    self.files([]);
  });
}
StagingViewModel.prototype.rebaseContinue = function() {
  var self = this;
  this.rebaseContinueProgressBar.start();
  this.server.post('/rebase/continue', { path: this.repoPath }, function(err, res) {
    self.resetMessages();
    self.rebaseContinueProgressBar.stop();
  });
}
StagingViewModel.prototype.rebaseAbort = function() {
  var self = this;
  this.rebaseAbortProgressBar.start();
  this.server.post('/rebase/abort', { path: this.repoPath }, function(err, res) {
    self.resetMessages();
    self.rebaseAbortProgressBar.stop();
  });
}
StagingViewModel.prototype.mergeContinue = function() {
  var self = this;
  this.mergeContinueProgressBar.start();
  var commitMessage = this.commitMessageTitle();
  if (this.commitMessageBody()) commitMessage += '\n\n' + this.commitMessageBody();
  this.server.post('/merge/continue', { path: this.repoPath, message: commitMessage }, function(err, res) {
    self.resetMessages();
    self.mergeContinueProgressBar.stop();
  });
}
StagingViewModel.prototype.mergeAbort = function() {
  var self = this;
  this.mergeAbortProgressBar.start();
  this.server.post('/merge/abort', { path: this.repoPath }, function(err, res) {
    self.resetMessages();
    self.mergeAbortProgressBar.stop();
  });
}
StagingViewModel.prototype.invalidateFilesDiffs = function() {
  this.files().forEach(function(file) {
    file.diff().invalidateDiff();
  });
}
StagingViewModel.prototype.discardAllChanges = function() {
  var self = this;
  var diag = components.create('yesnodialog', { title: 'Are you sure you want to discard all changes?', details: 'This operation cannot be undone.'});
  diag.closed.add(function() {
    if (diag.result()) self.server.post('/discardchanges', { path: self.repoPath, all: true });
  });
  programEvents.dispatch({ event: 'request-show-dialog', dialog: diag });
}
StagingViewModel.prototype.stashAll = function() {
  var self = this;
  this.stashProgressBar.start();
  this.server.post('/stashes', { path: this.repoPath, message: this.commitMessageTitle() }, function(err, res) {
    self.stashProgressBar.stop();
  });
}
StagingViewModel.prototype.toggleAllStages = function() {
  var self = this;
  for (var n in self.files()){
    self.files()[n].editState(self.allStageFlag() ? 'staged' : 'none');
  }

  self.allStageFlag(!self.allStageFlag());
}
StagingViewModel.prototype.textDiffTypeChange = function(type) {
  this.textDiffType(type);
}
StagingViewModel.prototype.onEnter = function(d, e){
    if (e.keyCode === 13 && !this.commitValidationError()) {
      this.commit();
    }
    return true;
};
StagingViewModel.prototype.onAltEnter = function(d, e){
    if (e.keyCode === 13 && e.altKey && !this.commitValidationError()) {
      this.commit();
    }
    return true;
};


var FileViewModel = function(staging, name, textDiffType) {
  var self = this;
  this.patchLineList = ko.observableArray();
  this.staging = staging;
  this.server = staging.server;
  this.editState = ko.observable('staged'); // staged, patched and none
  this.name = ko.observable(name);
  this.displayName = ko.observable(name);
  this.isNew = ko.observable(false);
  this.removed = ko.observable(false);
  this.conflict = ko.observable(false);
  this.renamed = ko.observable(false);
  this.isShowingDiffs = ko.observable(false);
  this.diffProgressBar = components.create('progressBar', { predictionMemoryKey: 'diffs-' + this.staging.repoPath, temporary: true });
  this.isShowingDiffs = ko.observable(false);
  this.textDiffType = textDiffType;
  this.additions = ko.observable('');
  this.deletions = ko.observable('');
  this.diff = ko.observable(self.getSpecificDiff());
  this.patchLineList = ko.observableArray();
  this.isShowPatch = ko.computed(function() {
    // if not new file
    // and if not merging
    // and if not rebasing
    // and if text file
    // and if diff is showing, display patch button
    return !self.isNew() && !staging.inMerge() && !staging.inRebase() && fileType(self.name()) === 'text' && self.isShowingDiffs();
  });
  this.diff = ko.observable(self.getSpecificDiff());

  this.editState.subscribe(function (value) {
    if (value === 'none') {
      self.patchLineList([]);
    } else if (value === 'patched') {
      if (self.diff().render) self.diff().render();
    }
  });
}
FileViewModel.prototype.getSpecificDiff = function() {
  return components.create(!this.name() || fileType(this.name()) === 'text' ? 'textdiff' : 'imagediff', {
    filename: this.name(),
    repoPath: this.staging.repoPath,
    server: this.server,
    textDiffType: this.textDiffType,
    isShowingDiffs: this.isShowingDiffs,
    diffProgressBar: this.diffProgressBar,
    patchLineList: this.patchLineList,
    editState: this.editState
  });
}
FileViewModel.prototype.setState = function(state) {
  this.displayName(state.displayName);
  this.isNew(state.isNew);
  this.removed(state.removed);
  this.conflict(state.conflict);
  this.renamed(state.renamed);
  this.additions(state.additions != '-' ? '+' + state.additions : '');
  this.deletions(state.deletions != '-' ? '-' + state.deletions : '');
  if (this.diff().isNew) this.diff().isNew(state.isNew);
  if (this.diff().isRemoved) this.diff().isRemoved(state.removed);
}
FileViewModel.prototype.toggleStaged = function() {
  if (this.editState() === 'none') {
    this.editState('staged');
  } else {
    this.editState('none');
  }
  this.patchLineList([]);
}
FileViewModel.prototype.discardChanges = function() {
  var self = this;
  if (ungit.config.disableDiscardWarning || new Date().getTime() - this.staging.mutedTime < ungit.config.disableDiscardMuteTime) {
    self.server.post('/discardchanges', { path: self.staging.repoPath, file: self.name() });
  } else {
    var diag = components.create('yesnomutedialog', { title: 'Are you sure you want to discard these changes?', details: 'This operation cannot be undone.'});
    diag.closed.add(function() {
      if (diag.result()) self.server.post('/discardchanges', { path: self.staging.repoPath, file: self.name() });
      if (diag.result() === "mute") self.staging.mutedTime = new Date().getTime();
    });
    programEvents.dispatch({ event: 'request-show-dialog', dialog: diag });
  }
}
FileViewModel.prototype.ignoreFile = function() {
  var self = this;
  this.server.post('/ignorefile', { path: this.staging.repoPath, file: this.name() }, function(err) {
    if (err && err.errorCode == 'file-already-git-ignored') {
      // The file was already in the .gitignore, so force an update of the staging area (to hopefull clear away this file)
      programEvents.dispatch({ event: 'working-tree-changed' });
      return true;
    }
  });
}
FileViewModel.prototype.resolveConflict = function() {
  this.server.post('/resolveconflicts', { path: this.staging.repoPath, files: [this.name()] });
}
FileViewModel.prototype.toggleDiffs = function() {
  if (this.renamed()) return; // do not show diffs for renames
  if (this.isShowingDiffs()) {
    this.isShowingDiffs(false);
  } else {
    this.isShowingDiffs(true);
    this.invalidateDiff();
  }
}
FileViewModel.prototype.patchClick = function() {
  if (!this.isShowingDiffs()) return;

  if (this.editState() === 'patched') {
    this.editState('staged');
  } else {
    this.editState('patched');
  }
}
FileViewModel.prototype.invalidateDiff = function() {
  this.diff().invalidateDiff();
}

},{"../../source/utils/file-type.js":2,"knockout":"knockout","lodash":"lodash","ungit-components":"ungit-components","ungit-program-events":"ungit-program-events","util":undefined}],2:[function(require,module,exports){
var path = require('path');
var imageFileExtensions = ['.PNG', '.JPG', '.BMP', '.GIF', '.JPEG'];

module.exports = function(fileName) {
  return imageFileExtensions.indexOf(path.extname(fileName).toUpperCase()) > -1 ? 'image' : 'text';
}

},{"path":undefined}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJjb21wb25lbnRzL3N0YWdpbmcvc3RhZ2luZy5qcyIsInNvdXJjZS91dGlscy9maWxlLXR5cGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzWkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKTt0aHJvdyBmLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwidmFyIGtvID0gcmVxdWlyZSgna25vY2tvdXQnKTtcbnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ3V0aWwnKS5pbmhlcml0cztcbnZhciBjb21wb25lbnRzID0gcmVxdWlyZSgndW5naXQtY29tcG9uZW50cycpO1xudmFyIHByb2dyYW1FdmVudHMgPSByZXF1aXJlKCd1bmdpdC1wcm9ncmFtLWV2ZW50cycpO1xudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBmaWxlc1RvRGlzcGxheUluY3JtZW50QnkgPSA1MDtcbnZhciBmaWxlc1RvRGlzcGxheUxpbWl0ID0gZmlsZXNUb0Rpc3BsYXlJbmNybWVudEJ5O1xudmFyIGZpbGVUeXBlID0gcmVxdWlyZSgnLi4vLi4vc291cmNlL3V0aWxzL2ZpbGUtdHlwZS5qcycpO1xuLy8gd2hlbiBkaXNjYXJkIGJ1dHRvbiBpcyBjbGlja2VkIGFuZCBkaXNhYmxlIGRpc2NhcmQgd2FybmluZyBpcyBzZWxlY3RlZCwgZm9yIG5leHQgNSBtaW51dGVzIGRpc2FibGUgZGlzY2FyZCB3YXJuaW5nc1xudmFyIG11dGVHcmFjZVRpbWVEdXJhdGlvbiA9IDYwICogMTAwMCAqIDU7XG5cbmNvbXBvbmVudHMucmVnaXN0ZXIoJ3N0YWdpbmcnLCBmdW5jdGlvbihhcmdzKSB7XG4gIHJldHVybiBuZXcgU3RhZ2luZ1ZpZXdNb2RlbChhcmdzLnNlcnZlciwgYXJncy5yZXBvUGF0aCk7XG59KTtcblxudmFyIFN0YWdpbmdWaWV3TW9kZWwgPSBmdW5jdGlvbihzZXJ2ZXIsIHJlcG9QYXRoKSB7XG4gIHZhciBzZWxmID0gdGhpcztcbiAgdGhpcy5zZXJ2ZXIgPSBzZXJ2ZXI7XG4gIHRoaXMucmVwb1BhdGggPSByZXBvUGF0aDtcbiAgdGhpcy5maWxlc0J5UGF0aCA9IHt9O1xuICB0aGlzLmZpbGVzID0ga28ub2JzZXJ2YWJsZUFycmF5KCk7XG4gIHRoaXMuY29tbWl0TWVzc2FnZVRpdGxlQ291bnQgPSBrby5vYnNlcnZhYmxlKDApO1xuICB0aGlzLmNvbW1pdE1lc3NhZ2VUaXRsZSA9IGtvLm9ic2VydmFibGUoKTtcbiAgdGhpcy5jb21taXRNZXNzYWdlVGl0bGUuc3Vic2NyaWJlKGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgc2VsZi5jb21taXRNZXNzYWdlVGl0bGVDb3VudCh2YWx1ZS5sZW5ndGgpO1xuICB9KTtcbiAgdGhpcy5jb21taXRNZXNzYWdlQm9keSA9IGtvLm9ic2VydmFibGUoKTtcbiAgdGhpcy5pblJlYmFzZSA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICB0aGlzLmluTWVyZ2UgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcbiAgdGhpcy5hbGxTdGFnZUZsYWcgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcbiAgdGhpcy5IRUFEID0ga28ub2JzZXJ2YWJsZSgpO1xuICB0aGlzLmNvbW1pdEJ1dHRvblZpc2libGUgPSBrby5jb21wdXRlZChmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gIXNlbGYuaW5SZWJhc2UoKSAmJiAhc2VsZi5pbk1lcmdlKCk7XG4gIH0pO1xuICB0aGlzLm5GaWxlcyA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBzZWxmLmZpbGVzKCkubGVuZ3RoO1xuICB9KTtcbiAgdGhpcy5uU3RhZ2VkRmlsZXMgPSBrby5jb21wdXRlZChmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gc2VsZi5maWxlcygpLmZpbHRlcihmdW5jdGlvbihmKSB7IHJldHVybiBmLmVkaXRTdGF0ZSgpID09PSAnc3RhZ2VkJzsgfSkubGVuZ3RoO1xuICB9KTtcbiAgdGhpcy5zdGF0cyA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBzZWxmLm5GaWxlcygpICsgJyBmaWxlcywgJyArIHNlbGYublN0YWdlZEZpbGVzKCkgKyAnIHRvIGJlIGNvbW1pdGVkJztcbiAgfSk7XG4gIHRoaXMuYW1lbmQgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcbiAgdGhpcy5jYW5BbWVuZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBzZWxmLkhFQUQoKSAmJiAhc2VsZi5pblJlYmFzZSgpICYmICFzZWxmLmluTWVyZ2UoKTtcbiAgfSk7XG4gIHRoaXMuY2FuU3Rhc2hBbGwgPSBrby5jb21wdXRlZChmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gIXNlbGYuYW1lbmQoKTtcbiAgfSk7XG4gIHRoaXMuc2hvd051eCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBzZWxmLmZpbGVzKCkubGVuZ3RoID09IDAgJiYgIXNlbGYuYW1lbmQoKSAmJiAhc2VsZi5pblJlYmFzZSgpO1xuICB9KTtcbiAgdGhpcy5jb21taXR0aW5nUHJvZ3Jlc3NCYXIgPSBjb21wb25lbnRzLmNyZWF0ZSgncHJvZ3Jlc3NCYXInLCB7IHByZWRpY3Rpb25NZW1vcnlLZXk6ICdjb21taXR0aW5nLScgKyB0aGlzLnJlcG9QYXRoLCB0ZW1wb3Jhcnk6IHRydWUgfSk7XG4gIHRoaXMucmViYXNlQ29udGludWVQcm9ncmVzc0JhciA9IGNvbXBvbmVudHMuY3JlYXRlKCdwcm9ncmVzc0JhcicsIHsgcHJlZGljdGlvbk1lbW9yeUtleTogJ3JlYmFzZS1jb250aW51ZS0nICsgdGhpcy5yZXBvUGF0aCwgdGVtcG9yYXJ5OiB0cnVlIH0pO1xuICB0aGlzLnJlYmFzZUFib3J0UHJvZ3Jlc3NCYXIgPSBjb21wb25lbnRzLmNyZWF0ZSgncHJvZ3Jlc3NCYXInLCB7IHByZWRpY3Rpb25NZW1vcnlLZXk6ICdyZWJhc2UtYWJvcnQtJyArIHRoaXMucmVwb1BhdGgsIHRlbXBvcmFyeTogdHJ1ZSB9KTtcbiAgdGhpcy5tZXJnZUNvbnRpbnVlUHJvZ3Jlc3NCYXIgPSBjb21wb25lbnRzLmNyZWF0ZSgncHJvZ3Jlc3NCYXInLCB7IHByZWRpY3Rpb25NZW1vcnlLZXk6ICdtZXJnZS1jb250aW51ZS0nICsgdGhpcy5yZXBvUGF0aCwgdGVtcG9yYXJ5OiB0cnVlIH0pO1xuICB0aGlzLm1lcmdlQWJvcnRQcm9ncmVzc0JhciA9IGNvbXBvbmVudHMuY3JlYXRlKCdwcm9ncmVzc0JhcicsIHsgcHJlZGljdGlvbk1lbW9yeUtleTogJ21lcmdlLWFib3J0LScgKyB0aGlzLnJlcG9QYXRoLCB0ZW1wb3Jhcnk6IHRydWUgfSk7XG4gIHRoaXMuc3Rhc2hQcm9ncmVzc0JhciA9IGNvbXBvbmVudHMuY3JlYXRlKCdwcm9ncmVzc0JhcicsIHsgcHJlZGljdGlvbk1lbW9yeUtleTogJ3N0YXNoLScgKyB0aGlzLnJlcG9QYXRoLCB0ZW1wb3Jhcnk6IHRydWUgfSk7XG4gIHRoaXMuY29tbWl0VmFsaWRhdGlvbkVycm9yID0ga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7XG4gICAgaWYgKCFzZWxmLmFtZW5kKCkgJiYgIXNlbGYuZmlsZXMoKS5zb21lKGZ1bmN0aW9uKGZpbGUpIHsgcmV0dXJuIGZpbGUuZWRpdFN0YXRlKCkgPT09ICdzdGFnZWQnIHx8IGZpbGUuZWRpdFN0YXRlKCkgPT09ICdwYXRjaGVkJzsgfSkpXG4gICAgICByZXR1cm4gXCJObyBmaWxlcyB0byBjb21taXRcIjtcblxuICAgIGlmIChzZWxmLmZpbGVzKCkuc29tZShmdW5jdGlvbihmaWxlKSB7IHJldHVybiBmaWxlLmNvbmZsaWN0KCk7IH0pKVxuICAgICAgcmV0dXJuIFwiRmlsZXMgaW4gY29uZmxpY3RcIjtcblxuICAgIGlmICghc2VsZi5jb21taXRNZXNzYWdlVGl0bGUoKSAmJiAhc2VsZi5pblJlYmFzZSgpKSByZXR1cm4gXCJQcm92aWRlIGEgdGl0bGVcIjtcblxuICAgIGlmIChzZWxmLnRleHREaWZmVHlwZSgpID09PSAnc2lkZWJ5c2lkZWRpZmYnKSB7XG4gICAgICB2YXIgcGF0Y2hGaWxlcyA9IHNlbGYuZmlsZXMoKS5maWx0ZXIoZnVuY3Rpb24oZmlsZSkgeyByZXR1cm4gZmlsZS5lZGl0U3RhdGUoKSA9PT0gJ3BhdGNoZWQnOyB9KTtcbiAgICAgIGlmIChwYXRjaEZpbGVzLmxlbmd0aCA+IDApIHJldHVybiBcIkNhbm5vdCBwYXRjaCB3aXRoIHNpZGUgYnkgc2lkZSB2aWV3LlwiXG4gICAgfVxuXG4gICAgcmV0dXJuIFwiXCI7XG4gIH0pO1xuICB0aGlzLnRvZ2dsZVNlbGVjdEFsbEdseXBoQ2xhc3MgPSBrby5jb21wdXRlZChmdW5jdGlvbigpIHtcbiAgICBpZiAoc2VsZi5hbGxTdGFnZUZsYWcoKSkgcmV0dXJuICdnbHlwaGljb24tdW5jaGVja2VkJztcbiAgICBlbHNlIHJldHVybiAnZ2x5cGhpY29uLWNoZWNrJztcbiAgfSk7XG5cbiAgdGhpcy5yZWZyZXNoQ29udGVudFRocm90dGxlZCA9IF8udGhyb3R0bGUodGhpcy5yZWZyZXNoQ29udGVudC5iaW5kKHRoaXMpLCA0MDAsIHsgdHJhaWxpbmc6IHRydWUgfSk7XG4gIHRoaXMuaW52YWxpZGF0ZUZpbGVzRGlmZnNUaHJvdHRsZWQgPSBfLnRocm90dGxlKHRoaXMuaW52YWxpZGF0ZUZpbGVzRGlmZnMuYmluZCh0aGlzKSwgNDAwLCB7IHRyYWlsaW5nOiB0cnVlIH0pO1xuICB0aGlzLnJlZnJlc2hDb250ZW50VGhyb3R0bGVkKCk7XG4gIHRoaXMudGV4dERpZmZUeXBlID0ga28ub2JzZXJ2YWJsZSgndGV4dGRpZmYnKTtcbiAgaWYgKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2guaW5kZXhPZignbm9oZWFkZXI9dHJ1ZScpID49IDApXG4gICAgdGhpcy5yZWZyZXNoQnV0dG9uID0gY29tcG9uZW50cy5jcmVhdGUoJ3JlZnJlc2hidXR0b24nKTtcbiAgdGhpcy5sb2FkQW55d2F5ID0gZmFsc2U7XG4gIHRoaXMuaXNEaWFnT3BlbiA9IGZhbHNlO1xuICB0aGlzLm11dGVkVGltZSA9IG51bGw7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS51cGRhdGVOb2RlID0gZnVuY3Rpb24ocGFyZW50RWxlbWVudCkge1xuICBrby5yZW5kZXJUZW1wbGF0ZSgnc3RhZ2luZycsIHRoaXMsIHt9LCBwYXJlbnRFbGVtZW50KTtcbn1cblN0YWdpbmdWaWV3TW9kZWwucHJvdG90eXBlLm9uUHJvZ3JhbUV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgaWYgKGV2ZW50LmV2ZW50ID09ICdyZXF1ZXN0LWFwcC1jb250ZW50LXJlZnJlc2gnKSB7XG4gICAgdGhpcy5yZWZyZXNoQ29udGVudCgpO1xuICAgIHRoaXMuaW52YWxpZGF0ZUZpbGVzRGlmZnMoKTtcbiAgfVxuICBpZiAoZXZlbnQuZXZlbnQgPT0gJ3dvcmtpbmctdHJlZS1jaGFuZ2VkJykge1xuICAgIHRoaXMucmVmcmVzaENvbnRlbnRUaHJvdHRsZWQoKTtcbiAgICB0aGlzLmludmFsaWRhdGVGaWxlc0RpZmZzVGhyb3R0bGVkKCk7XG4gIH1cbn1cblN0YWdpbmdWaWV3TW9kZWwucHJvdG90eXBlLnJlZnJlc2hDb250ZW50ID0gZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgdmFyIHNlbGYgPSB0aGlzO1xuICB0aGlzLnNlcnZlci5nZXQoJy9oZWFkJywgeyBwYXRoOiB0aGlzLnJlcG9QYXRoLCBsaW1pdDogMSB9LCBmdW5jdGlvbihlcnIsIGxvZykge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIHJldHVybiBlcnIuZXJyb3JDb2RlID09ICdtdXN0LWJlLWluLXdvcmtpbmctdHJlZScgfHxcbiAgICAgICAgZXJyLmVycm9yQ29kZSA9PSAnbm8tc3VjaC1wYXRoJztcbiAgICB9XG4gICAgaWYgKGxvZy5sZW5ndGggPiAwKSB7XG4gICAgICB2YXIgYXJyYXkgPSBsb2dbMF0ubWVzc2FnZS5zcGxpdCgnXFxuJyk7XG4gICAgICBzZWxmLkhFQUQoe3RpdGxlOiBhcnJheVswXSwgYm9keTogYXJyYXkuc2xpY2UoMikuam9pbignXFxuJyl9KTtcbiAgICB9XG4gICAgZWxzZSBzZWxmLkhFQUQobnVsbCk7XG4gIH0pO1xuICB0aGlzLnNlcnZlci5nZXQoJy9zdGF0dXMnLCB7IHBhdGg6IHRoaXMucmVwb1BhdGgsIGZpbGVMaW1pdDogZmlsZXNUb0Rpc3BsYXlMaW1pdCB9LCBmdW5jdGlvbihlcnIsIHN0YXR1cykge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyKTtcbiAgICAgIHJldHVybiBlcnIuZXJyb3JDb2RlID09ICdtdXN0LWJlLWluLXdvcmtpbmctdHJlZScgfHxcbiAgICAgICAgZXJyLmVycm9yQ29kZSA9PSAnbm8tc3VjaC1wYXRoJztcbiAgICB9XG5cbiAgICBpZiAoT2JqZWN0LmtleXMoc3RhdHVzLmZpbGVzKS5sZW5ndGggPiBmaWxlc1RvRGlzcGxheUxpbWl0ICYmICFzZWxmLmxvYWRBbnl3YXkpIHtcbiAgICAgIGlmIChzZWxmLmlzRGlhZ09wZW4pIHtcbiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBzZWxmLmlzRGlhZ09wZW4gPSB0cnVlO1xuICAgICAgdmFyIGRpYWcgPSBjb21wb25lbnRzLmNyZWF0ZSgnVG9vTWFueUZpbGVzRGlhbG9nVmlld01vZGVsJywgeyB0aXRsZTogJ1RvbyBtYW55IHVuc3RhZ2VkIGZpbGVzJywgZGV0YWlsczogJ0l0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSBjb21tYW5kIGxpbmUgYXMgdW5naXQgbWF5IGJlIHRvbyBzbG93Lid9KTtcblxuICAgICAgZGlhZy5jbG9zZWQuYWRkKGZ1bmN0aW9uKCkge1xuICAgICAgICBzZWxmLmlzRGlhZ09wZW4gPSBmYWxzZTtcbiAgICAgICAgaWYgKGRpYWcucmVzdWx0KCkpIHtcbiAgICAgICAgICBzZWxmLmxvYWRBbnl3YXkgPSB0cnVlO1xuICAgICAgICAgIHNlbGYubG9hZFN0YXR1cyhzdGF0dXMsIGNhbGxiYWNrKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9ICcvIy8nO1xuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICBwcm9ncmFtRXZlbnRzLmRpc3BhdGNoKHsgZXZlbnQ6ICdyZXF1ZXN0LXNob3ctZGlhbG9nJywgZGlhbG9nOiBkaWFnIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZWxmLmxvYWRTdGF0dXMoc3RhdHVzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9KTtcbn1cblN0YWdpbmdWaWV3TW9kZWwucHJvdG90eXBlLmxvYWRTdGF0dXMgPSBmdW5jdGlvbihzdGF0dXMsIGNhbGxiYWNrKSB7XG4gIHRoaXMuc2V0RmlsZXMoc3RhdHVzLmZpbGVzKTtcbiAgdGhpcy5pblJlYmFzZSghIXN0YXR1cy5pblJlYmFzZSk7XG4gIHRoaXMuaW5NZXJnZSghIXN0YXR1cy5pbk1lcmdlKTtcbiAgaWYgKHN0YXR1cy5pbk1lcmdlKSB7XG4gICAgdmFyIGxpbmVzID0gc3RhdHVzLmNvbW1pdE1lc3NhZ2Uuc3BsaXQoJ1xcbicpO1xuICAgIHRoaXMuY29tbWl0TWVzc2FnZVRpdGxlKGxpbmVzWzBdKTtcbiAgICB0aGlzLmNvbW1pdE1lc3NhZ2VCb2R5KGxpbmVzLnNsaWNlKDEpLmpvaW4oJ1xcbicpKTtcbiAgfVxuICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5zZXRGaWxlcyA9IGZ1bmN0aW9uKGZpbGVzKSB7XG4gIHZhciBzZWxmID0gdGhpcztcbiAgdmFyIG5ld0ZpbGVzID0gW107XG4gIGZvcih2YXIgZmlsZSBpbiBmaWxlcykge1xuICAgIHZhciBmaWxlVmlld01vZGVsID0gdGhpcy5maWxlc0J5UGF0aFtmaWxlXTtcbiAgICBpZiAoIWZpbGVWaWV3TW9kZWwpIHtcbiAgICAgIHRoaXMuZmlsZXNCeVBhdGhbZmlsZV0gPSBmaWxlVmlld01vZGVsID0gbmV3IEZpbGVWaWV3TW9kZWwoc2VsZiwgZmlsZSwgc2VsZi50ZXh0RGlmZlR5cGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyB0aGlzIGlzIG1haW5seSBmb3IgcGF0Y2hpbmcgYW5kIGl0IG1heSBub3QgZmlyZSBkdWUgdG8gdGhlIGZhY3QgdGhhdFxuICAgICAgLy8gJy9jb21taXQnIHRyaWdnZXJzIHdvcmtpbmctdHJlZS1jaGFuZ2VkIHdoaWNoIHRyaWdnZXJzIHRocm90dGxlZCByZWZyZXNoXG4gICAgICBmaWxlVmlld01vZGVsLmludmFsaWRhdGVEaWZmKCk7XG4gICAgfVxuICAgIGZpbGVWaWV3TW9kZWwuc2V0U3RhdGUoZmlsZXNbZmlsZV0pO1xuICAgIG5ld0ZpbGVzLnB1c2goZmlsZVZpZXdNb2RlbCk7XG4gIH1cbiAgdGhpcy5maWxlcyhuZXdGaWxlcyk7XG4gIHByb2dyYW1FdmVudHMuZGlzcGF0Y2goeyBldmVudDogJ2luaXQtdG9vbHRpcCcgfSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS50b2dnbGVBbWVuZCA9IGZ1bmN0aW9uKCkge1xuICBpZiAoIXRoaXMuYW1lbmQoKSAmJiAhdGhpcy5jb21taXRNZXNzYWdlVGl0bGUoKSkge1xuICAgIHRoaXMuY29tbWl0TWVzc2FnZVRpdGxlKHRoaXMuSEVBRCgpLnRpdGxlKTtcbiAgICB0aGlzLmNvbW1pdE1lc3NhZ2VCb2R5KHRoaXMuSEVBRCgpLmJvZHkpO1xuICB9XG4gIGVsc2UgaWYodGhpcy5hbWVuZCgpKSB7XG4gICAgdmFyIGlzUHJldkRlZmF1bHRNc2cgPVxuICAgICAgdGhpcy5jb21taXRNZXNzYWdlVGl0bGUoKSA9PSB0aGlzLkhFQUQoKS50aXRsZSAmJlxuICAgICAgdGhpcy5jb21taXRNZXNzYWdlQm9keSgpID09IHRoaXMuSEVBRCgpLmJvZHk7XG4gICAgaWYgKGlzUHJldkRlZmF1bHRNc2cpIHtcbiAgICAgIHRoaXMuY29tbWl0TWVzc2FnZVRpdGxlKCcnKTtcbiAgICAgIHRoaXMuY29tbWl0TWVzc2FnZUJvZHkoJycpO1xuICAgIH1cbiAgfVxuICB0aGlzLmFtZW5kKCF0aGlzLmFtZW5kKCkpO1xufVxuU3RhZ2luZ1ZpZXdNb2RlbC5wcm90b3R5cGUucmVzZXRNZXNzYWdlcyA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLmNvbW1pdE1lc3NhZ2VUaXRsZSgnJyk7XG4gIHRoaXMuY29tbWl0TWVzc2FnZUJvZHkoJycpO1xuICB0aGlzLmFtZW5kKGZhbHNlKTtcbn1cblN0YWdpbmdWaWV3TW9kZWwucHJvdG90eXBlLmNvbW1pdCA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHRoaXMuY29tbWl0dGluZ1Byb2dyZXNzQmFyLnN0YXJ0KCk7XG4gIHZhciBmaWxlcyA9IHRoaXMuZmlsZXMoKS5maWx0ZXIoZnVuY3Rpb24oZmlsZSkge1xuICAgIHJldHVybiBmaWxlLmVkaXRTdGF0ZSgpICE9PSAnbm9uZSc7XG4gIH0pLm1hcChmdW5jdGlvbihmaWxlKSB7XG4gICAgcmV0dXJuIHsgbmFtZTogZmlsZS5uYW1lKCksIHBhdGNoTGluZUxpc3Q6IGZpbGUuZWRpdFN0YXRlKCkgPT09ICdwYXRjaGVkJyA/IGZpbGUucGF0Y2hMaW5lTGlzdCgpIDogbnVsbCB9O1xuICB9KTtcbiAgdmFyIGNvbW1pdE1lc3NhZ2UgPSB0aGlzLmNvbW1pdE1lc3NhZ2VUaXRsZSgpO1xuICBpZiAodGhpcy5jb21taXRNZXNzYWdlQm9keSgpKSBjb21taXRNZXNzYWdlICs9ICdcXG5cXG4nICsgdGhpcy5jb21taXRNZXNzYWdlQm9keSgpO1xuICB0aGlzLnNlcnZlci5wb3N0KCcvY29tbWl0JywgeyBwYXRoOiB0aGlzLnJlcG9QYXRoLCBtZXNzYWdlOiBjb21taXRNZXNzYWdlLCBmaWxlczogZmlsZXMsIGFtZW5kOiB0aGlzLmFtZW5kKCkgfSwgZnVuY3Rpb24oZXJyLCByZXMpIHtcbiAgICBzZWxmLmNvbW1pdHRpbmdQcm9ncmVzc0Jhci5zdG9wKCk7XG4gICAgaWYgKGVycikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzZWxmLnJlc2V0TWVzc2FnZXMoKTtcbiAgICBzZWxmLmZpbGVzKFtdKTtcbiAgfSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5yZWJhc2VDb250aW51ZSA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHRoaXMucmViYXNlQ29udGludWVQcm9ncmVzc0Jhci5zdGFydCgpO1xuICB0aGlzLnNlcnZlci5wb3N0KCcvcmViYXNlL2NvbnRpbnVlJywgeyBwYXRoOiB0aGlzLnJlcG9QYXRoIH0sIGZ1bmN0aW9uKGVyciwgcmVzKSB7XG4gICAgc2VsZi5yZXNldE1lc3NhZ2VzKCk7XG4gICAgc2VsZi5yZWJhc2VDb250aW51ZVByb2dyZXNzQmFyLnN0b3AoKTtcbiAgfSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5yZWJhc2VBYm9ydCA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHRoaXMucmViYXNlQWJvcnRQcm9ncmVzc0Jhci5zdGFydCgpO1xuICB0aGlzLnNlcnZlci5wb3N0KCcvcmViYXNlL2Fib3J0JywgeyBwYXRoOiB0aGlzLnJlcG9QYXRoIH0sIGZ1bmN0aW9uKGVyciwgcmVzKSB7XG4gICAgc2VsZi5yZXNldE1lc3NhZ2VzKCk7XG4gICAgc2VsZi5yZWJhc2VBYm9ydFByb2dyZXNzQmFyLnN0b3AoKTtcbiAgfSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5tZXJnZUNvbnRpbnVlID0gZnVuY3Rpb24oKSB7XG4gIHZhciBzZWxmID0gdGhpcztcbiAgdGhpcy5tZXJnZUNvbnRpbnVlUHJvZ3Jlc3NCYXIuc3RhcnQoKTtcbiAgdmFyIGNvbW1pdE1lc3NhZ2UgPSB0aGlzLmNvbW1pdE1lc3NhZ2VUaXRsZSgpO1xuICBpZiAodGhpcy5jb21taXRNZXNzYWdlQm9keSgpKSBjb21taXRNZXNzYWdlICs9ICdcXG5cXG4nICsgdGhpcy5jb21taXRNZXNzYWdlQm9keSgpO1xuICB0aGlzLnNlcnZlci5wb3N0KCcvbWVyZ2UvY29udGludWUnLCB7IHBhdGg6IHRoaXMucmVwb1BhdGgsIG1lc3NhZ2U6IGNvbW1pdE1lc3NhZ2UgfSwgZnVuY3Rpb24oZXJyLCByZXMpIHtcbiAgICBzZWxmLnJlc2V0TWVzc2FnZXMoKTtcbiAgICBzZWxmLm1lcmdlQ29udGludWVQcm9ncmVzc0Jhci5zdG9wKCk7XG4gIH0pO1xufVxuU3RhZ2luZ1ZpZXdNb2RlbC5wcm90b3R5cGUubWVyZ2VBYm9ydCA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHRoaXMubWVyZ2VBYm9ydFByb2dyZXNzQmFyLnN0YXJ0KCk7XG4gIHRoaXMuc2VydmVyLnBvc3QoJy9tZXJnZS9hYm9ydCcsIHsgcGF0aDogdGhpcy5yZXBvUGF0aCB9LCBmdW5jdGlvbihlcnIsIHJlcykge1xuICAgIHNlbGYucmVzZXRNZXNzYWdlcygpO1xuICAgIHNlbGYubWVyZ2VBYm9ydFByb2dyZXNzQmFyLnN0b3AoKTtcbiAgfSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5pbnZhbGlkYXRlRmlsZXNEaWZmcyA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLmZpbGVzKCkuZm9yRWFjaChmdW5jdGlvbihmaWxlKSB7XG4gICAgZmlsZS5kaWZmKCkuaW52YWxpZGF0ZURpZmYoKTtcbiAgfSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5kaXNjYXJkQWxsQ2hhbmdlcyA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHZhciBkaWFnID0gY29tcG9uZW50cy5jcmVhdGUoJ3llc25vZGlhbG9nJywgeyB0aXRsZTogJ0FyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkaXNjYXJkIGFsbCBjaGFuZ2VzPycsIGRldGFpbHM6ICdUaGlzIG9wZXJhdGlvbiBjYW5ub3QgYmUgdW5kb25lLid9KTtcbiAgZGlhZy5jbG9zZWQuYWRkKGZ1bmN0aW9uKCkge1xuICAgIGlmIChkaWFnLnJlc3VsdCgpKSBzZWxmLnNlcnZlci5wb3N0KCcvZGlzY2FyZGNoYW5nZXMnLCB7IHBhdGg6IHNlbGYucmVwb1BhdGgsIGFsbDogdHJ1ZSB9KTtcbiAgfSk7XG4gIHByb2dyYW1FdmVudHMuZGlzcGF0Y2goeyBldmVudDogJ3JlcXVlc3Qtc2hvdy1kaWFsb2cnLCBkaWFsb2c6IGRpYWcgfSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5zdGFzaEFsbCA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHRoaXMuc3Rhc2hQcm9ncmVzc0Jhci5zdGFydCgpO1xuICB0aGlzLnNlcnZlci5wb3N0KCcvc3Rhc2hlcycsIHsgcGF0aDogdGhpcy5yZXBvUGF0aCwgbWVzc2FnZTogdGhpcy5jb21taXRNZXNzYWdlVGl0bGUoKSB9LCBmdW5jdGlvbihlcnIsIHJlcykge1xuICAgIHNlbGYuc3Rhc2hQcm9ncmVzc0Jhci5zdG9wKCk7XG4gIH0pO1xufVxuU3RhZ2luZ1ZpZXdNb2RlbC5wcm90b3R5cGUudG9nZ2xlQWxsU3RhZ2VzID0gZnVuY3Rpb24oKSB7XG4gIHZhciBzZWxmID0gdGhpcztcbiAgZm9yICh2YXIgbiBpbiBzZWxmLmZpbGVzKCkpe1xuICAgIHNlbGYuZmlsZXMoKVtuXS5lZGl0U3RhdGUoc2VsZi5hbGxTdGFnZUZsYWcoKSA/ICdzdGFnZWQnIDogJ25vbmUnKTtcbiAgfVxuXG4gIHNlbGYuYWxsU3RhZ2VGbGFnKCFzZWxmLmFsbFN0YWdlRmxhZygpKTtcbn1cblN0YWdpbmdWaWV3TW9kZWwucHJvdG90eXBlLnRleHREaWZmVHlwZUNoYW5nZSA9IGZ1bmN0aW9uKHR5cGUpIHtcbiAgdGhpcy50ZXh0RGlmZlR5cGUodHlwZSk7XG59XG5TdGFnaW5nVmlld01vZGVsLnByb3RvdHlwZS5vbkVudGVyID0gZnVuY3Rpb24oZCwgZSl7XG4gICAgaWYgKGUua2V5Q29kZSA9PT0gMTMgJiYgIXRoaXMuY29tbWl0VmFsaWRhdGlvbkVycm9yKCkpIHtcbiAgICAgIHRoaXMuY29tbWl0KCk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufTtcblN0YWdpbmdWaWV3TW9kZWwucHJvdG90eXBlLm9uQWx0RW50ZXIgPSBmdW5jdGlvbihkLCBlKXtcbiAgICBpZiAoZS5rZXlDb2RlID09PSAxMyAmJiBlLmFsdEtleSAmJiAhdGhpcy5jb21taXRWYWxpZGF0aW9uRXJyb3IoKSkge1xuICAgICAgdGhpcy5jb21taXQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59O1xuXG5cbnZhciBGaWxlVmlld01vZGVsID0gZnVuY3Rpb24oc3RhZ2luZywgbmFtZSwgdGV4dERpZmZUeXBlKSB7XG4gIHZhciBzZWxmID0gdGhpcztcbiAgdGhpcy5wYXRjaExpbmVMaXN0ID0ga28ub2JzZXJ2YWJsZUFycmF5KCk7XG4gIHRoaXMuc3RhZ2luZyA9IHN0YWdpbmc7XG4gIHRoaXMuc2VydmVyID0gc3RhZ2luZy5zZXJ2ZXI7XG4gIHRoaXMuZWRpdFN0YXRlID0ga28ub2JzZXJ2YWJsZSgnc3RhZ2VkJyk7IC8vIHN0YWdlZCwgcGF0Y2hlZCBhbmQgbm9uZVxuICB0aGlzLm5hbWUgPSBrby5vYnNlcnZhYmxlKG5hbWUpO1xuICB0aGlzLmRpc3BsYXlOYW1lID0ga28ub2JzZXJ2YWJsZShuYW1lKTtcbiAgdGhpcy5pc05ldyA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICB0aGlzLnJlbW92ZWQgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcbiAgdGhpcy5jb25mbGljdCA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICB0aGlzLnJlbmFtZWQgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcbiAgdGhpcy5pc1Nob3dpbmdEaWZmcyA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICB0aGlzLmRpZmZQcm9ncmVzc0JhciA9IGNvbXBvbmVudHMuY3JlYXRlKCdwcm9ncmVzc0JhcicsIHsgcHJlZGljdGlvbk1lbW9yeUtleTogJ2RpZmZzLScgKyB0aGlzLnN0YWdpbmcucmVwb1BhdGgsIHRlbXBvcmFyeTogdHJ1ZSB9KTtcbiAgdGhpcy5pc1Nob3dpbmdEaWZmcyA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICB0aGlzLnRleHREaWZmVHlwZSA9IHRleHREaWZmVHlwZTtcbiAgdGhpcy5hZGRpdGlvbnMgPSBrby5vYnNlcnZhYmxlKCcnKTtcbiAgdGhpcy5kZWxldGlvbnMgPSBrby5vYnNlcnZhYmxlKCcnKTtcbiAgdGhpcy5kaWZmID0ga28ub2JzZXJ2YWJsZShzZWxmLmdldFNwZWNpZmljRGlmZigpKTtcbiAgdGhpcy5wYXRjaExpbmVMaXN0ID0ga28ub2JzZXJ2YWJsZUFycmF5KCk7XG4gIHRoaXMuaXNTaG93UGF0Y2ggPSBrby5jb21wdXRlZChmdW5jdGlvbigpIHtcbiAgICAvLyBpZiBub3QgbmV3IGZpbGVcbiAgICAvLyBhbmQgaWYgbm90IG1lcmdpbmdcbiAgICAvLyBhbmQgaWYgbm90IHJlYmFzaW5nXG4gICAgLy8gYW5kIGlmIHRleHQgZmlsZVxuICAgIC8vIGFuZCBpZiBkaWZmIGlzIHNob3dpbmcsIGRpc3BsYXkgcGF0Y2ggYnV0dG9uXG4gICAgcmV0dXJuICFzZWxmLmlzTmV3KCkgJiYgIXN0YWdpbmcuaW5NZXJnZSgpICYmICFzdGFnaW5nLmluUmViYXNlKCkgJiYgZmlsZVR5cGUoc2VsZi5uYW1lKCkpID09PSAndGV4dCcgJiYgc2VsZi5pc1Nob3dpbmdEaWZmcygpO1xuICB9KTtcbiAgdGhpcy5kaWZmID0ga28ub2JzZXJ2YWJsZShzZWxmLmdldFNwZWNpZmljRGlmZigpKTtcblxuICB0aGlzLmVkaXRTdGF0ZS5zdWJzY3JpYmUoZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlID09PSAnbm9uZScpIHtcbiAgICAgIHNlbGYucGF0Y2hMaW5lTGlzdChbXSk7XG4gICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJ3BhdGNoZWQnKSB7XG4gICAgICBpZiAoc2VsZi5kaWZmKCkucmVuZGVyKSBzZWxmLmRpZmYoKS5yZW5kZXIoKTtcbiAgICB9XG4gIH0pO1xufVxuRmlsZVZpZXdNb2RlbC5wcm90b3R5cGUuZ2V0U3BlY2lmaWNEaWZmID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiBjb21wb25lbnRzLmNyZWF0ZSghdGhpcy5uYW1lKCkgfHwgZmlsZVR5cGUodGhpcy5uYW1lKCkpID09PSAndGV4dCcgPyAndGV4dGRpZmYnIDogJ2ltYWdlZGlmZicsIHtcbiAgICBmaWxlbmFtZTogdGhpcy5uYW1lKCksXG4gICAgcmVwb1BhdGg6IHRoaXMuc3RhZ2luZy5yZXBvUGF0aCxcbiAgICBzZXJ2ZXI6IHRoaXMuc2VydmVyLFxuICAgIHRleHREaWZmVHlwZTogdGhpcy50ZXh0RGlmZlR5cGUsXG4gICAgaXNTaG93aW5nRGlmZnM6IHRoaXMuaXNTaG93aW5nRGlmZnMsXG4gICAgZGlmZlByb2dyZXNzQmFyOiB0aGlzLmRpZmZQcm9ncmVzc0JhcixcbiAgICBwYXRjaExpbmVMaXN0OiB0aGlzLnBhdGNoTGluZUxpc3QsXG4gICAgZWRpdFN0YXRlOiB0aGlzLmVkaXRTdGF0ZVxuICB9KTtcbn1cbkZpbGVWaWV3TW9kZWwucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24oc3RhdGUpIHtcbiAgdGhpcy5kaXNwbGF5TmFtZShzdGF0ZS5kaXNwbGF5TmFtZSk7XG4gIHRoaXMuaXNOZXcoc3RhdGUuaXNOZXcpO1xuICB0aGlzLnJlbW92ZWQoc3RhdGUucmVtb3ZlZCk7XG4gIHRoaXMuY29uZmxpY3Qoc3RhdGUuY29uZmxpY3QpO1xuICB0aGlzLnJlbmFtZWQoc3RhdGUucmVuYW1lZCk7XG4gIHRoaXMuYWRkaXRpb25zKHN0YXRlLmFkZGl0aW9ucyAhPSAnLScgPyAnKycgKyBzdGF0ZS5hZGRpdGlvbnMgOiAnJyk7XG4gIHRoaXMuZGVsZXRpb25zKHN0YXRlLmRlbGV0aW9ucyAhPSAnLScgPyAnLScgKyBzdGF0ZS5kZWxldGlvbnMgOiAnJyk7XG4gIGlmICh0aGlzLmRpZmYoKS5pc05ldykgdGhpcy5kaWZmKCkuaXNOZXcoc3RhdGUuaXNOZXcpO1xuICBpZiAodGhpcy5kaWZmKCkuaXNSZW1vdmVkKSB0aGlzLmRpZmYoKS5pc1JlbW92ZWQoc3RhdGUucmVtb3ZlZCk7XG59XG5GaWxlVmlld01vZGVsLnByb3RvdHlwZS50b2dnbGVTdGFnZWQgPSBmdW5jdGlvbigpIHtcbiAgaWYgKHRoaXMuZWRpdFN0YXRlKCkgPT09ICdub25lJykge1xuICAgIHRoaXMuZWRpdFN0YXRlKCdzdGFnZWQnKTtcbiAgfSBlbHNlIHtcbiAgICB0aGlzLmVkaXRTdGF0ZSgnbm9uZScpO1xuICB9XG4gIHRoaXMucGF0Y2hMaW5lTGlzdChbXSk7XG59XG5GaWxlVmlld01vZGVsLnByb3RvdHlwZS5kaXNjYXJkQ2hhbmdlcyA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIGlmICh1bmdpdC5jb25maWcuZGlzYWJsZURpc2NhcmRXYXJuaW5nIHx8IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdGhpcy5zdGFnaW5nLm11dGVkVGltZSA8IHVuZ2l0LmNvbmZpZy5kaXNhYmxlRGlzY2FyZE11dGVUaW1lKSB7XG4gICAgc2VsZi5zZXJ2ZXIucG9zdCgnL2Rpc2NhcmRjaGFuZ2VzJywgeyBwYXRoOiBzZWxmLnN0YWdpbmcucmVwb1BhdGgsIGZpbGU6IHNlbGYubmFtZSgpIH0pO1xuICB9IGVsc2Uge1xuICAgIHZhciBkaWFnID0gY29tcG9uZW50cy5jcmVhdGUoJ3llc25vbXV0ZWRpYWxvZycsIHsgdGl0bGU6ICdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZGlzY2FyZCB0aGVzZSBjaGFuZ2VzPycsIGRldGFpbHM6ICdUaGlzIG9wZXJhdGlvbiBjYW5ub3QgYmUgdW5kb25lLid9KTtcbiAgICBkaWFnLmNsb3NlZC5hZGQoZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoZGlhZy5yZXN1bHQoKSkgc2VsZi5zZXJ2ZXIucG9zdCgnL2Rpc2NhcmRjaGFuZ2VzJywgeyBwYXRoOiBzZWxmLnN0YWdpbmcucmVwb1BhdGgsIGZpbGU6IHNlbGYubmFtZSgpIH0pO1xuICAgICAgaWYgKGRpYWcucmVzdWx0KCkgPT09IFwibXV0ZVwiKSBzZWxmLnN0YWdpbmcubXV0ZWRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgfSk7XG4gICAgcHJvZ3JhbUV2ZW50cy5kaXNwYXRjaCh7IGV2ZW50OiAncmVxdWVzdC1zaG93LWRpYWxvZycsIGRpYWxvZzogZGlhZyB9KTtcbiAgfVxufVxuRmlsZVZpZXdNb2RlbC5wcm90b3R5cGUuaWdub3JlRmlsZSA9IGZ1bmN0aW9uKCkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHRoaXMuc2VydmVyLnBvc3QoJy9pZ25vcmVmaWxlJywgeyBwYXRoOiB0aGlzLnN0YWdpbmcucmVwb1BhdGgsIGZpbGU6IHRoaXMubmFtZSgpIH0sIGZ1bmN0aW9uKGVycikge1xuICAgIGlmIChlcnIgJiYgZXJyLmVycm9yQ29kZSA9PSAnZmlsZS1hbHJlYWR5LWdpdC1pZ25vcmVkJykge1xuICAgICAgLy8gVGhlIGZpbGUgd2FzIGFscmVhZHkgaW4gdGhlIC5naXRpZ25vcmUsIHNvIGZvcmNlIGFuIHVwZGF0ZSBvZiB0aGUgc3RhZ2luZyBhcmVhICh0byBob3BlZnVsbCBjbGVhciBhd2F5IHRoaXMgZmlsZSlcbiAgICAgIHByb2dyYW1FdmVudHMuZGlzcGF0Y2goeyBldmVudDogJ3dvcmtpbmctdHJlZS1jaGFuZ2VkJyB9KTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5GaWxlVmlld01vZGVsLnByb3RvdHlwZS5yZXNvbHZlQ29uZmxpY3QgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5zZXJ2ZXIucG9zdCgnL3Jlc29sdmVjb25mbGljdHMnLCB7IHBhdGg6IHRoaXMuc3RhZ2luZy5yZXBvUGF0aCwgZmlsZXM6IFt0aGlzLm5hbWUoKV0gfSk7XG59XG5GaWxlVmlld01vZGVsLnByb3RvdHlwZS50b2dnbGVEaWZmcyA9IGZ1bmN0aW9uKCkge1xuICBpZiAodGhpcy5yZW5hbWVkKCkpIHJldHVybjsgLy8gZG8gbm90IHNob3cgZGlmZnMgZm9yIHJlbmFtZXNcbiAgaWYgKHRoaXMuaXNTaG93aW5nRGlmZnMoKSkge1xuICAgIHRoaXMuaXNTaG93aW5nRGlmZnMoZmFsc2UpO1xuICB9IGVsc2Uge1xuICAgIHRoaXMuaXNTaG93aW5nRGlmZnModHJ1ZSk7XG4gICAgdGhpcy5pbnZhbGlkYXRlRGlmZigpO1xuICB9XG59XG5GaWxlVmlld01vZGVsLnByb3RvdHlwZS5wYXRjaENsaWNrID0gZnVuY3Rpb24oKSB7XG4gIGlmICghdGhpcy5pc1Nob3dpbmdEaWZmcygpKSByZXR1cm47XG5cbiAgaWYgKHRoaXMuZWRpdFN0YXRlKCkgPT09ICdwYXRjaGVkJykge1xuICAgIHRoaXMuZWRpdFN0YXRlKCdzdGFnZWQnKTtcbiAgfSBlbHNlIHtcbiAgICB0aGlzLmVkaXRTdGF0ZSgncGF0Y2hlZCcpO1xuICB9XG59XG5GaWxlVmlld01vZGVsLnByb3RvdHlwZS5pbnZhbGlkYXRlRGlmZiA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLmRpZmYoKS5pbnZhbGlkYXRlRGlmZigpO1xufVxuIiwidmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG52YXIgaW1hZ2VGaWxlRXh0ZW5zaW9ucyA9IFsnLlBORycsICcuSlBHJywgJy5CTVAnLCAnLkdJRicsICcuSlBFRyddO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGZpbGVOYW1lKSB7XG4gIHJldHVybiBpbWFnZUZpbGVFeHRlbnNpb25zLmluZGV4T2YocGF0aC5leHRuYW1lKGZpbGVOYW1lKS50b1VwcGVyQ2FzZSgpKSA+IC0xID8gJ2ltYWdlJyA6ICd0ZXh0Jztcbn1cbiJdfQ==
